!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var o=e();for(var r in o)("object"==typeof exports?exports:t)[r]=o[r]}}("undefined"!=typeof self?self:this,(function(){return function(){"use strict";var t={d:function(e,o){for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r:function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{StreamCompositor:function(){return O}});var o,r={code:1100001,message:"input param error."},i={code:1103074,message:"video track is not readable"},n={code:1103076,message:"audio track is not readable"},s={code:1103077,message:"compositor blur not support."},a=function(){function t(t,e,o){this.logger=t,this.stateCenter=e,this.streamCenter=o,this.fps=15,this.outputBitrate=1500,this.hasPortrait=!1,this.isClear=!1,this.canvasEl=document.createElement("canvas"),this.ctx=this.canvasEl.getContext("2d")}return t.prototype.setVideoConfig=function(t){var e=t.height,o=t.frameRate,r=t.bitrate;this.canvasEl.width=t.width,this.canvasEl.height=e,o&&(this.fps=o),r&&(this.outputBitrate=r)},t.prototype.setInputsOption=function(t){var e=this;this.isClear=!0,this.layers=t.filter((function(t){var e=t.stream,o=t.option,r=t.source instanceof HTMLImageElement,n=void 0!==o.contentType&&["ALL","VIDEO"].includes(o.contentType),s=!o.contentType||n,a=e&&e.getVideoTracks();if(0==(null==a?void 0:a.length)&&n)throw i;return r||s&&a&&(null==a?void 0:a.length)>0})).map((function(t){var o,r=t.source,i=t.stream,n=t.option;if(i&&"safari"===e.stateCenter.browser){var s=e.streamCenter.checkPreview(i);s.backgroundProcessor?(o=s.backgroundProcessor.getCanvas(),e.bgProcessor=s.backgroundProcessor,e.hasPortrait=!0):e.hasPortrait=!1}return{source:r,option:n,canvas:o}})),this.layers.sort((function(t,e){var o,r;return void 0!==(null===(o=t.option.layout)||void 0===o?void 0:o.zOrder)&&void 0!==(null===(r=e.option.layout)||void 0===r?void 0:r.zOrder)?t.option.layout.zOrder-e.option.layout.zOrder:-1}))},t.prototype.checkVideoInputs=function(t){var e=!0;return t.forEach((function(t){var o=t.stream,r=t.option,i=void 0!==r.contentType&&["ALL","VIDEO"].includes(r.contentType),n=o&&o.getVideoTracks();0==(null==n?void 0:n.length)&&i&&(e=!1)})),e},t.prototype.generateVideoTrack=function(){var t,e=this;if(this.hasPortrait?null===(t=this.bgProcessor)||void 0===t||t.setDrawBack((function(){e.draw()})):this.intervalId||(this.intervalId=setInterval((function(){e.draw()}),1e3/this.fps)),!this.canvasTrack){var o=this.canvasEl.captureStream(this.fps);this.canvasTrack=o.getVideoTracks()[0]}return this.canvasTrack},t.prototype.stopOutputStream=function(){var t;this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.layers.forEach((function(t){t.source&&t.source instanceof HTMLVideoElement&&(t.source.pause(),t.source.remove(),t.source.srcObject=null,t.source=null)})),null===(t=this.canvasTrack)||void 0===t||t.stop(),this.canvasTrack=null,this.ctx=null,this.layers=[]},t.prototype.draw=function(){var t,e;if(this.ctx){this.ctx.clearRect(0,0,this.canvasEl.width,this.canvasEl.height);for(var o=0;o<this.layers.length;o++){var r=this.layers[o],i=r.source,n=r.option,s=r.canvas;if(n.layout){var a=n.layout,u=a.x,c=a.y,p=a.width,h=a.height,l=i instanceof HTMLVideoElement?i.videoWidth:i instanceof HTMLImageElement?i.naturalWidth:0,d=i instanceof HTMLVideoElement?i.videoHeight:i instanceof HTMLImageElement?i.naturalHeight:0;if(0==l||0==d){console.warn("w、h is zero");continue}var m=s||i;switch(n.objectFit){case"contain":if(p/h<=l/d){var f=(h-(y=p*d/l))/2;null===(t=this.ctx)||void 0===t||t.drawImage(m,u,c+f,p,y)}else{f=(p-(v=h*l/d))/2;null===(e=this.ctx)||void 0===e||e.drawImage(m,u+f,c,v,h)}break;case"cover":var v,y;if(p/h<=l/d)this.ctx.drawImage(m,(l-(v=p*d/h))/2,0,v,d,u,c,p,h);else this.ctx.drawImage(m,0,(d-(y=l*h/p))/2,l,y,u,c,p,h);break;case"fill":this.ctx.drawImage(m,u,c,p,h)}}}}},t}(),u=function(){function t(t,e,o){this.logger=t,this.ac=e,this.streamCenter=o,this.inputs=[],this.descNode=this.ac.createMediaStreamDestination()}return t.prototype.setInputsOption=function(t){var e=this;this.inputs=t.filter((function(t){var o=t.stream,r=t.option,i=o&&o.getAudioTracks(),s=e.streamCenter.checkPreview(o),a=void 0!==r.contentType&&["ALL","AUDIO"].includes(r.contentType);if((0==(null==i?void 0:i.length)||(null==s?void 0:s.hasEmptyAudioTrack))&&a)throw n;return i&&(null==i?void 0:i.length)>0})),this.inputs.forEach((function(t){var e,o,r=t.audioNodes,i=t.option;(void 0===t.option.volume&&(t.option.volume=100),r)&&(!i.contentType||["ALL","AUDIO"].includes(i.contentType)?(!r.hasAudio&&(null===(e=null==r?void 0:r.srcNode)||void 0===e||e.connect(r.volumeNode)),r.hasAudio=!0,"number"==typeof t.option.volume&&(r.volumeNode.gain.value=t.option.volume/100)):(null===(o=null==r?void 0:r.srcNode)||void 0===o||o.disconnect(r.volumeNode),r.hasAudio=!1))}))},t.prototype.checkAudioInputs=function(t){var e=this,o=!0;return t.forEach((function(t){var r=t.stream,i=t.option,n=r&&r.getAudioTracks(),s=e.streamCenter.checkPreview(r),a=void 0!==i.contentType&&["ALL","AUDIO"].includes(i.contentType);(0==(null==n?void 0:n.length)||(null==s?void 0:s.hasEmptyAudioTrack))&&a&&(o=!1)})),o},t.prototype.generateAudioTrack=function(){for(var t,e=0;e<this.inputs.length;e++){var o=this.inputs[e],r=o.stream,i=o.option,n=!i.contentType||["ALL","AUDIO"].includes(i.contentType),s=this.createAudioNode(r,o.option.volume),a=s.srcNode,u=s.volumeNode;n&&(null==a||a.connect(u)),o.audioNodes={srcNode:a,volumeNode:u,hasAudio:n}}var c=null===(t=this.descNode)||void 0===t?void 0:t.stream.getAudioTracks();return c&&c.length>0?c[0]:(this.ac.resume(),null)},t.prototype.createAudioNode=function(t,e){var o=this.ac.createMediaStreamSource(t),r=this.ac.createGain();return r.gain.value=e/100,r.connect(this.descNode),{srcNode:o,volumeNode:r}},t.prototype.stopAudioCompositor=function(){for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t],o=e.audioNodes,r=e.option;if(o){var i=o.srcNode,n=o.volumeNode;(!r.contentType||["ALL","AUDIO"].includes(r.contentType))&&(null==i||i.disconnect(n),null==n||n.disconnect(this.descNode)),o.volumeNode=null,o.srcNode=null}this.descNode=null}this.inputs=[]},t.prototype.replaceSource=function(t){var e=this;this.inputs.forEach((function(o){var r=o.stream,i=o.audioNodes;if(t===r&&i){var n=i.srcNode,s=i.volumeNode,a=i.hasAudio,u=e.ac.createMediaStreamSource(r);a&&(null==n||n.disconnect(s),u.connect(s)),i.srcNode=u}}))},t}();!function(t){t.STREAM_COMPOSITOR_MODULE="zc.scm.0"}(o||(o={}));var c,p={event:"/sdk/init"},h={event:"/sdk/create_stream_compositor"},l={event:"/sdk/start_compositing_stream",error:{},media_stream_id:function(t){return t},compose_stream_conf:function(t){return t}},d=function(){return d=Object.assign||function(t){for(var e,o=1,r=arguments.length;o<r;o++)for(var i in e=arguments[o])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},d.apply(this,arguments)},m=function(t,e,o,r){return new(o||(o=Promise))((function(i,n){function s(t){try{u(r.next(t))}catch(t){n(t)}}function a(t){try{u(r.throw(t))}catch(t){n(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(s,a)}u((r=r.apply(t,e||[])).next())}))},f=function(t,e){var o,r,i,n,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function a(n){return function(a){return function(n){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,r&&(i=2&n[0]?r.return:n[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,n[1])).done)return i;switch(r=0,i&&(n=[2&n[0],i.value]),n[0]){case 0:case 1:i=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,r=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==n[0]&&2!==n[0])){s=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){s.label=n[1];break}if(6===n[0]&&s.label<i[1]){s.label=i[1],i=n;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(n);break}i[2]&&s.ops.pop(),s.trys.pop();continue}n=e.call(t,s)}catch(t){n=[6,t],r=0}finally{o=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}},v=function(){function t(t,e,o,r){this.logger=t,this.stateCenter=e,this.streamCenter=o,this.ac=r,this.mixOutputConfig={width:0,height:0,frameRate:15,bitrate:2500},this.inputStreamOptions=[],this.fit="cover",this.videoCompositor=new a(t,e,o),this.audioCompositor=new u(t,r,o)}return t.prototype.setOutputConfig=function(t){if("number"!=typeof t.width)throw Error("param width error");if("number"!=typeof t.height)throw Error("param height error");if(void 0!==t.frameRate&&"number"!=typeof t.frameRate)throw Error("param frameRate error");if(void 0!==t.bitrate&&"number"!=typeof t.bitrate)throw Error("param bitrate error");this.mixOutputConfig=d(d({},this.mixOutputConfig),t),this.videoCompositor.setVideoConfig(this.mixOutputConfig)},t.prototype.setInputEndpoint=function(t,e){return m(this,void 0,void 0,(function(){var o,r;return f(this,(function(s){switch(s.label){case 0:if(!this.checkStreamIsLocal(t))throw Error("stream is not from zego");return o=this.inputStreamOptions.find((function(e){return e.stream===t})),this.checkInputOption(e,!!o),o?(o.option=this.assignObj(o.option,e),[3,3]):[3,1];case 1:return[4,this.createVideo(t)];case 2:r=s.sent(),this.addInputLayer({source:r,stream:t,option:d({objectFit:this.fit},e)}),s.label=3;case 3:if(!this.videoCompositor.checkVideoInputs(this.inputStreamOptions))throw i;if(!this.audioCompositor.checkAudioInputs(this.inputStreamOptions))throw n;return this.videoCompositor.setInputsOption(this.inputStreamOptions),this.audioCompositor.setInputsOption(this.inputStreamOptions),[2]}}))}))},t.prototype.addImage=function(t,e){this.checkImg(t);var o=this.inputStreamOptions.find((function(e){return e.source===t}));this.checkInputOption(e,!!o),o?o.option=this.assignObj(o.option,e):this.addInputLayer({source:t,option:d({objectFit:this.fit},e)}),this.videoCompositor.setInputsOption(this.inputStreamOptions)},t.prototype.removeImage=function(t){this.checkImg(t);var e=this.inputStreamOptions.findIndex((function(e){return e.source===t}));e>0&&(this.inputStreamOptions.splice(e,1),this.videoCompositor.setInputsOption(this.inputStreamOptions))},t.prototype.startComposingStream=function(){var t=this;return new Promise((function(e,o){if(!t.checkOutputs())return t.logger.error("zc.sc.scs.0 output config error"),void o(r);if(!t.checkInputs())return t.logger.error("zc.sc.scs.0 input params error"),void o(r);if(!t.checkBrowserSupport())return t.logger.error("zc.sc.scs.0 browser not support compositor"),void o(s);t.videoCompositor.setInputsOption(t.inputStreamOptions);var i=t.videoCompositor.generateVideoTrack();t.audioCompositor.setInputsOption(t.inputStreamOptions);var n=t.audioCompositor.generateAudioTrack();t.uploadEvent();var a=[i];n&&a.push(n);var u=new MediaStream(a);t.outputStream=u,t.streamCenter.createCompositingPreviewer(u,t.mixOutputConfig,t.inputStreamOptions),e(u)}))},t.prototype.stopComposingStream=function(){var t=this;return new Promise((function(e){var o,r;if(t.outputStream){var i=t.streamCenter.checkPreview(t.outputStream);i&&(null===(o=i.rtcViewer)||void 0===o||o.destroy(),i.streamCompositor=null,t.streamCenter.removePreview(i)),null===(r=t.outputStream)||void 0===r||r.getTracks().forEach((function(t){return t.stop()}))}try{t.videoCompositor.stopOutputStream(),t.audioCompositor.stopAudioCompositor()}catch(t){e(!1)}t.inputStreamOptions=[],e(!0)}))},t.prototype.checkInputs=function(){var t=this.mixOutputConfig,e=t.width,o=t.height;return this.inputStreamOptions.every((function(t){var r=t.option.layout;return r.x<=e&&r.y<=o&&r.x+r.width<=e&&r.y+r.height<=o&&r.width<=e&&r.height<=o}))},t.prototype.checkOutputs=function(){var t=this.mixOutputConfig;return t.width>0&&t.height>0&&t.frameRate>0&&t.bitrate>0},t.prototype.uploadEvent=function(){var t=this.stateCenter.reporter.createSpan(c.H,{key:p.event},{key:""},l.event),e=this.inputStreamOptions.map((function(t){var e=t.option,o=e.layout,r=e.objectFit,i=e.contentType;return{content_control:"AUDIO"===i?1:"VIDEO"===i?2:0,x:o.x,y:o.y,w:o.width,h:o.height,order:o.zOrder,render_mode:"cover"===r?0:"contain"===r?1:2}})),o=this.mixOutputConfig;t.setAttributes({compose_stream_conf:l.compose_stream_conf({fps:o.frameRate,bitrate:o.bitrate,w:o.width,h:o.height,stream_cnt:e.length,input_stream_list:e})}),t.end()},t.prototype.checkImg=function(t){if(!(t&&t instanceof HTMLImageElement&&t.naturalWidth))throw this.logger.error(o.STREAM_COMPOSITOR_MODULE+" source must be image and loaded"),Error("source must be image and loaded")},t.prototype.checkInputOption=function(t,e){var o=this;if(void 0!==t.layout){if("object"!=typeof t.layout)throw Error("param layout error");["x","y","width","height"].forEach((function(r){o.checkNumParam(t.layout,r,e)})),this.checkOptionalNumOptParam(t.layout,"zOrder")}if(void 0!==t.objectFit&&!["cover","contain","fill"].includes(t.objectFit))throw Error("param objectFit error");if(void 0!==t.contentType&&!["ALL","VIDEO","AUDIO"].includes(t.contentType))throw Error("param contentType error");this.checkOptionalNumOptParam(t,"volume")},t.prototype.checkNumParam=function(t,e,o){if(o&&void 0===t[e]);else if("number"!=typeof t[e])throw Error("param ".concat(e," error"))},t.prototype.checkOptionalNumOptParam=function(t,e){if(void 0!==t[e]&&"number"!=typeof t[e])throw Error("param ".concat(e," error"))},t.prototype.checkStreamIsLocal=function(t){var e=this.streamCenter.checkPreview(t),o=this.streamCenter.checkPlayer(t);return e&&(e.streamCompositor=this),!!e||!!o},t.prototype.addInputLayer=function(t){var e,o=t.option;void 0===(null===(e=o.layout)||void 0===e?void 0:e.zOrder)&&(o.layout.zOrder=0),this.inputStreamOptions.push(t)},t.prototype.createVideo=function(t){return m(this,void 0,void 0,(function(){var e=this;return f(this,(function(o){return[2,new Promise((function(o,r){return m(e,void 0,void 0,(function(){var e,n,s,a,u=this;return f(this,(function(c){return(e=document.createElement("video")).setAttribute("autoplay","autoplay"),e.setAttribute("muted","true"),e.muted=!0,e.setAttribute("playsinline","playsinline"),e.setAttribute("style","display:none"),n=null,s=function(){n&&(clearTimeout(n),n=null),e.play().catch((function(t){console.error(t)})),n=window.setTimeout((function(){u.logger.warn("zc.sc.cv  video track error"),r(i)}),1e3)},a=function(){n&&clearTimeout(n),e&&e.removeEventListener("playing",a),o(e)},e&&e.addEventListener("playing",a),e.srcObject=t,e.play().catch((function(t){console.error(t)})),n=window.setTimeout((function(){s()}),1e3),[2]}))}))}))]}))}))},t.prototype.assignObj=function(t,e){void 0===t&&(t={});var o=t;if("object"!=typeof t||"object"!=typeof e)return e;for(var r in e)o[r]=t.hasOwnProperty(r)?this.assignObj(t[r],e[r]):e[r];return o},t.prototype.replaceSource=function(t){this.audioCompositor.replaceSource(t)},t.prototype.checkBrowserSupport=function(){var t=!0,e=navigator.userAgent.toLowerCase().match(/cpu iphone os (.*?) like mac os/);return e&&e[1]&&e[1].includes("14_6")&&(t=!1),t},t}(),y=function(){function t(t){this.compositor=t}return t.prototype.addImage=function(t,e){this.compositor.addImage(t,e)},t.prototype.removeImage=function(t){this.compositor.removeImage(t)},t.prototype.setInputEndpoint=function(t,e){return this.compositor.setInputEndpoint(t,e)},t.prototype.setOutputConfig=function(t){this.compositor.setOutputConfig(t)},t.prototype.startComposingStream=function(){return this.compositor.startComposingStream()},t.prototype.stopComposingStream=function(){return this.compositor.stopComposingStream()},t}();!function(t){t[t.I=0]="I",t[t.H=10]="H",t[t.M=100]="M",t[t.L=1e3]="L"}(c||(c={}));var g={createStreamCompositor:function(){var t=this.stateCenter.reporter.createSpan(c.H,{key:p.event},{key:""},h.event),e=new v(this.logger,this.stateCenter,this.streamCenter,this.ac);return t.end(),new y(e)}},O={install:function(t){for(var e in g)Object.defineProperty(t.prototype,e,{value:g[e],writable:!1})},get type(){return"StreamCompositor"}};return e}()}));